---
title: "ARPAH Demographic Metrics"
execute:
  echo: false
---
The Advanced Research Projects Agency for Health (ARPA-H) is a research funding agency that supports transformative biomedical and health breakthroughs – ranging from the molecular to the societal – to provide health solutions for all.
For more information, you can [Visit Stanford News](https://med.stanford.edu/news/all-news/2024/10/arpa-h-contracts).


# **Clinical Metrics*

```{r}
# set wrking directory
setwd("/workspaces/starr-oncology-data-lake-arpah/src")
source("/workspaces/starr-oncology-data-lake-arpah/src/R/all_function.R", encoding = "UTF-8")

```
```{r, message=FALSE, warning=FALSE, results='hide'}
 credentials_path <- "/home/rstudio/.config/gcloud/application_default_credentials.json"
  conn <- dbConnect(
    bigrquery::bigquery(),
    project = "som-rit-phi-oncology-prod",
    use_legacy_sql = FALSE
  )

folder_path <- "/workspaces/starr-oncology-data-lake-arpah/src/sql/arpah_clinical"

sql_files <- list.files(path = folder_path, pattern = "\\.sql$", full.names = TRUE)

combined_df <- sql_files %>%
  purrr::map_dfr(~{
    sql_query <- readLines(.x)
  
    df <- dbGetQuery(conn, paste(sql_query, collapse = "\n")) 
     df <- df %>%
      mutate(sql_file_name = basename(.x))
    return(df)
  })

```
```{r,message=FALSE, warning=FALSE, results='hide'}
#Total
metric_arpah <- df %>%
  mutate(
    metric = case_when(
      sql_file_name == "note_path_cyto_person_metrics.sql" ~ "with pathology/cytology clinical report", 
      sql_file_name == "note_imaging_person_metrics.sql" ~ "with imaging reports, also a proxy for radiology imaging data",
      sql_file_name == "philips_person_metrics.sql" ~ "have molecular mutation structured data (Philips ISPM)",
      sql_file_name == "vital_status_person_metrics.sql" ~ "present Hospital or Stanford Cancer Registry death date", 
      sql_file_name == "omop_chemo_person_metrics.sql" ~ "given chemo medication",
      sql_file_name == "aria_person_metrics.sql" ~ "given radiation therapy (ARIA)",
      sql_file_name == "wsi_beaker_path_person_metrics.sql" ~ "with WSI (based on EPIC Beaker AP/Pathology, starting from 2022)",
      sql_file_name == "powerpath_beaker_path_person_metrics.sql" ~ "pathology beaker",
      sql_file_name == "powerpath_path_person_metrics.sql" ~ "pathology path",
      TRUE ~ NA_character_  
    )
  )
print(metric_arpah)
#with pathology/cytology clinical report
#with imaging reports, also a proxy for radiology imaging data
#have molecular mutation structured data (Philips ISPM)
#present data in Stanford Cancer Registry (Neural Frame)
#present Hospital or Stanford Cancer Registry death date
#given chemo medication
#given radiation therapy (ARIA)
#with WSI (based on EPIC Beaker AP/Pathology, starting from 2022)
```
This table summerizes the following clinical metrics for the number of patients with pathology reports, imaging reports, and other clinical characteristics.
```{r, message=FALSE, warning=FALSE}
metric_arpah<-metric_arpah%>% select(metric, everything())

metric_arpah %>% select (-sql_file_name) %>%
  gt() %>%
  cols_label(
    metric = "Clinical Metrics",
    patient_count = "Count (N)",
  ) %>%
  tab_header(
    title = "Clinical Metrics",
    subtitle = "ARPAH Cohort"
  ) %>%
  fmt_number(
    columns = where(is.numeric),
    decimals = 0
  ) %>%
  cols_align(
    align = "center",
    columns = vars(patient_count)  # Specify the columns to center
  ) %>%
  tab_options(
    table.font.size = px(14),
    heading.align = "left",
    table.border.top.color = "darkred",
    table.align = "left"
  ) %>%
  opt_row_striping()


```

```{r, message=FALSE, warning=FALSE}
metric_arpah %>%
  gt() %>%
  cols_label(
    metric = "Clinical Metrics",
    patient_count = "Count (N)",
  ) %>%
  tab_header(
    title = "Clinical Metrics",
    subtitle = "ARPAH Cohort"
  ) %>%
  fmt_number(
    columns = where(is.numeric),
    decimals = 0
  ) %>%
  cols_align(
    align = "center",
    columns = vars(patient_count)  # Specify the columns to center
  ) %>%
  tab_options(
    table.font.size = px(14),
    heading.align = "left",
    table.border.top.color = "darkred",
    table.align = "left"
  ) %>%
  opt_row_striping()
```

```{r}
credentials_path <- "/home/rstudio/.config/gcloud/application_default_credentials.json"
  conn <- dbConnect(
    bigrquery::bigquery(),
    project = "som-rit-phi-oncology-prod",
    use_legacy_sql = FALSE
  )

folder_path_tb <- "/workspaces/starr-oncology-data-lake-arpah/src/sql/tumor_board"

sql_files_tb <- list.files(path = folder_path_tb, pattern = "\\.sql$", full.names = TRUE)

combined_df_tb <- sql_files_tb %>%
  purrr::map_dfr(~{
    sql_query <- readLines(.x)
  
    df <- dbGetQuery(conn, paste(sql_query, collapse = "\n")) 
     df <- df %>%
      mutate(sql_file_name = basename(.x))
    return(df)
  })

colnames(combined_df_tb)[1]<-"pt_count_tb"
combined_df_tb$sql_file_name=gsub("tumor_board_","", combined_df_tb$sql_file_name)
colnames(combined_df)[1]<-"pt_count_arp"

```
```{r}
df=combined_df %>% inner_join(combined_df_tb, by="sql_file_name")
print(df)

```
```{r, message=FALSE, warning=FALSE}
metric_arpah<-metric_arpah%>% select(metric, everything())

metric_arpah%>% select(-sql_file_name) %>%
  gt() %>%
  cols_label(
    metric = "Clinical Metrics",
    pt_count_arp = "ARPAH Count (N)",
    pt_count_tb="Tumor Board Count (N)",
  ) %>%
  tab_header(
    title = "Clinical Metrics",
    subtitle = "ARPAH Cohort"
  ) %>%
  fmt_number(
    columns = where(is.numeric),
    decimals = 0
  ) %>%
  cols_align(
    align = "center",
    columns = vars(pt_count_arp, pt_count_tb)  # Specify the columns to center
  ) %>%
  tab_options(
    table.font.size = px(14),
    heading.align = "left",
    table.border.top.color = "darkred",
    table.align = "left"
  ) %>%
  opt_row_striping()
```