---
title: "PDF Media Server Documents"
execute:
  echo: false
draft: false
listing: false
engine: knitr
---

```{r, message=FALSE, warning=FALSE, results='hide'}
#| context: global

rm(list=ls())
source("/workspaces/starr-oncology-data-lake-arpah/src/R/all_function.R", encoding = "UTF-8")
yaml_file_path <-  "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql_params.yml"
library(RColorBrewer)  
library(plotly)
library(DT)
library(dplyr)
library(ggplot2)
library(stringr)
library(tidytext)
```



This analysis examines the distribution of document types in the Epic Media Server PDFs dataset for ARPAH cancer patients.

### Combined Document and Patient Counts

```{r, message=FALSE, warning=FALSE, results='hide'}
# Load document type counts
doc_counts_sql <- "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql_std/pdf_media/document_type_counts.sql"
doc_counts <- fetch_data_from_sql_file(doc_counts_sql, yaml_file_path)

# Load unique patient counts by document type
patient_counts_sql <- "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql_std/pdf_media/document_type_patient_counts.sql"
patient_counts <- fetch_data_from_sql_file(patient_counts_sql, yaml_file_path)

# Clean document information type (remove reverse question marks and other special characters)
clean_document_type <- function(text) {
  text %>%
    # Remove reverse question marks and similar characters
    gsub("¿", "", .) %>%
    # Remove other problematic characters
    gsub("â€™", "'", .) %>%
    gsub("â€œ", '"', .) %>%
    gsub("â€", '"', .) %>%
    # Trim whitespace
    trimws(.)
}

# Apply cleaning to both datasets
doc_counts$document_information_type <- clean_document_type(doc_counts$document_information_type)
patient_counts$document_information_type <- clean_document_type(patient_counts$document_information_type)

```

### Categorized Document Analysis

```{r, message=FALSE, warning=FALSE}
# Create combined dataset with raw calculations
combined_data <- doc_counts %>%
  left_join(patient_counts, by = "document_information_type") %>%
  arrange(desc(document_count))

# Calculate total patients for coverage calculations
total_unique_patients <- max(combined_data$unique_patient_count)

# Add coverage calculations to combined data
combined_data <- combined_data %>%
  mutate(
    docs_per_patient = round(document_count / unique_patient_count, 2),
    patient_coverage_pct = round((unique_patient_count / total_unique_patients) * 100, 2)
  )

# Display combined data with calculations
combined_data %>%
  select(
    document_information_type,
    document_count,
    unique_patient_count,
    docs_per_patient,
    patient_coverage_pct
  ) %>%
  DT::datatable(
    caption = "Document Type Analysis: Raw Data with Coverage Metrics",
    options = list(
      pageLength = 20,
      scrollX = TRUE,
      searchHighlight = TRUE
    ),
    rownames = FALSE,
    colnames = c(
      "Document Information Type",
      "Total Documents",
      "Unique Patients",
      "Docs per Patient",
      "Patient Coverage %"
    )
  ) %>%
  DT::formatCurrency(c("document_count", "unique_patient_count"), currency = "", interval = 3, mark = ",", digits = 0) %>%
  DT::formatRound(c("docs_per_patient", "patient_coverage_pct"), digits = 2)
```






### Categorized Document Types

#### Document Categorization Summary

The following categorization logic groups 150+ individual document types into 17 meaningful categories using text pattern matching:

• **Laboratory & Genetic Testing**: Includes lab results, genetic/genomic reports, STAMP panels, CSMP tests, pathology reports, and specimen analysis

• **Radiology & Imaging**: Covers radiology reports, imaging studies, echocardiograms, stress tests, DICOM files, CT/MRI/X-ray results

• **External/Outside Records**: Documents from external healthcare providers, outside facilities, and referral sources

• **Consent & Legal Documents**: Patient consents, authorizations, release forms, HIPAA documents, advance directives, DNR orders, POLST forms

• **Administrative Documents**: Insurance forms, financial records, billing information, registration documents, identification cards, disability/pension paperwork

• **Clinical Notes & Documentation**: Progress notes, H&P reports, consultation notes, clinic visits, assessments, evaluations, clinical summaries

• **Orders & Prescriptions**: Medical orders, prescriptions, requisitions, infusion protocols

• **Radiation Oncology**: Radiation treatment plans, simulation reports, physics calculations, radiation oncology documentation

• **Surgery & Procedures**: Operative reports, surgical procedures, procedural documentation

• **Patient Education & Instructions**: Educational materials, patient instructions, treatment information, care plans

• **Correspondence & Communication**: Letters, correspondence, notifications, messages between providers and patients

• **Clinical Photography**: Patient photos, clinical images, dermatology photos

• **Research & Studies**: Research documentation, clinical studies, GRC (Genetic Research Center) materials

• **Transplant Related**: All transplant-related documentation and protocols

• **Emergency & Urgent Care**: Emergency department records, ambulance reports, urgent care documentation

• **Attachments & Uploads**: General attachments, uploaded documents, scanned materials

• **Other/Miscellaneous**: Documents that don't match any specific category pattern

```{r, message=FALSE, warning=FALSE}
# Apply categorization directly to existing combined_data
categorized_data <- combined_data %>%
  mutate(
    document_category = case_when(
      # Laboratory/Testing Results
      str_detect(tolower(document_information_type), "lab|genetic|genomic|stamp|csmp|pathology|specimen|test result") ~ "Laboratory & Genetic Testing",
      
      # Radiology & Imaging
      str_detect(tolower(document_information_type), "rad|radiology|imaging|echo|stress|dicom|ct|mri|xray|x-ray") ~ "Radiology & Imaging",
      
      # External/Outside Records
      str_detect(tolower(document_information_type), "external|outside|referral") ~ "External/Outside Records",
      
      # Consent & Legal Documents  
      str_detect(tolower(document_information_type), "consent|authorization|roi|release|hipaa|advance directive|living will|dnr|polst|legal") ~ "Consent & Legal Documents",
      
      # Administrative Documents
      str_detect(tolower(document_information_type), "admin|insurance|financial|billing|registration|identification|card|tax|pay stub|award letter|disability|unemployment|pension") ~ "Administrative Documents",
      
      # Clinical Notes & Documentation
      str_detect(tolower(document_information_type), "note|h&p|progress|consult|clinic|visit|assessment|evaluation|summary|documentation") ~ "Clinical Notes & Documentation",
      
      # Orders & Prescriptions
      str_detect(tolower(document_information_type), "order|prescription|rx|requisition|infusion") ~ "Orders & Prescriptions",
      
      # Radiation Oncology
      str_detect(tolower(document_information_type), "rad onc|radiation|treatment plan|simulation|physics") ~ "Radiation Oncology",
      
      # Surgery & Procedures
      str_detect(tolower(document_information_type), "op report|operative|procedure|surgery|surgical") ~ "Surgery & Procedures",
      
      # Patient Education & Instructions
      str_detect(tolower(document_information_type), "education|instruction|patient treatment information|plan of care") ~ "Patient Education & Instructions",
      
      # Correspondence & Communication
      str_detect(tolower(document_information_type), "letter|correspondence|notification|message") ~ "Correspondence & Communication",
      
      # Photos & Images
      str_detect(tolower(document_information_type), "photo|image|derm") ~ "Clinical Photography",
      
      # Research & Studies
      str_detect(tolower(document_information_type), "research|study|grc") ~ "Research & Studies",
      
      # Transplant Related
      str_detect(tolower(document_information_type), "transplant") ~ "Transplant Related",
      
      # Emergency & Urgent Care
      str_detect(tolower(document_information_type), "ed |ambulance|emergency") ~ "Emergency & Urgent Care",
      
      # Attachments & Uploads
      str_detect(tolower(document_information_type), "attachment|upload|scan") ~ "Attachments & Uploads",
      
      TRUE ~ "Other/Miscellaneous"
    )
  )

# Create a list of all categories for reference
unique_categories <- categorized_data %>%
  select(document_category) %>%
  distinct() %>%
  arrange(document_category) %>%
  pull(document_category)

# Write categorized data to CSV file
write.csv(categorized_data, 
          "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/pdf_media_categorized_data.csv", 
          row.names = FALSE)

# Also write category summary to CSV
category_summary_export <- categorized_data %>%
  group_by(document_category) %>%
  summarise(
    total_documents = sum(document_count),
    unique_subtypes = n(),
    max_patients_reached = max(unique_patient_count),
    avg_docs_per_patient = round(mean(docs_per_patient, na.rm = TRUE), 2),
    max_coverage_pct = round(max(patient_coverage_pct, na.rm = TRUE), 2),
    .groups = 'drop'
  ) %>%
  arrange(desc(total_documents))

write.csv(category_summary_export, 
          "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/pdf_media_category_summary.csv", 
          row.names = FALSE)
```

### Scatter Plot: Document Volume vs Patient Coverage

```{r, message=FALSE, warning=FALSE, fig.width=12, fig.height=8}
# Create scatter plot showing relationship between metrics with category hover
p_scatter <- categorized_data %>%
  ggplot(aes(x = patient_coverage_pct, y = document_count, 
             text = paste("Document Type:", document_information_type,
                         "\nCategory:", document_category,
                         "\nPatient Coverage:", paste0(patient_coverage_pct, "%"),
                         "\nDocs per Patient:", docs_per_patient))) +
  geom_point(aes(size = docs_per_patient, color = docs_per_patient), alpha = 0.7) +
  geom_text(aes(label = ifelse(document_count > quantile(document_count, 0.8) | 
                              patient_coverage_pct > quantile(patient_coverage_pct, 0.8),
                              str_trunc(document_information_type, 25), "")),
            size = 2.5, vjust = -0.5, hjust = 0.5) +
  scale_color_viridis_c(name = "Docs per\nPatient") +
  scale_size_continuous(name = "Docs per\nPatient", range = c(2, 12)) +
  labs(
    title = "Document Volume vs Patient Coverage by Category",
    subtitle = "Size and color represent docs per patient ratio - Hover for category details",
    x = "Patient Coverage %",
    y = "Total Document Count"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 11, color = "#7f8c8d"),
    legend.position = "right"
  ) +
  scale_y_continuous(labels = scales::comma_format())

ggplotly(p_scatter, tooltip = "text")
```

### High Coverage Documents: Patient Coverage Above 10%

```{r, message=FALSE, warning=FALSE, fig.width=12, fig.height=8}
# Filter for documents with patient coverage above 10%
high_coverage_data <- categorized_data %>%
  filter(patient_coverage_pct > 10)

# Create scatter plot for high coverage documents
p_scatter_filtered <- high_coverage_data %>%
  ggplot(aes(x = patient_coverage_pct, y = document_count, 
             text = paste("Document Type:", document_information_type,
                         "\nCategory:", document_category,
                         "\nPatient Coverage:", paste0(patient_coverage_pct, "%"),
                         "\nDocs per Patient:", docs_per_patient))) +
  geom_point(aes(size = docs_per_patient, color = document_category), alpha = 0.8) +
  geom_text(aes(label = str_trunc(document_information_type, 20)), 
            size = 2.8, vjust = -0.5, hjust = 0.5, alpha = 0.7) +
  scale_color_viridis_d(name = "Document\nCategory", option = "plasma") +
  scale_size_continuous(name = "Docs per\nPatient", range = c(3, 15)) +
  labs(
    title = "High Coverage Documents: Patient Coverage Above 10%",
    subtitle = "Documents reaching more than 10% of patient population - Color by category",
    x = "Patient Coverage %",
    y = "Total Document Count"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 11, color = "#7f8c8d"),
    legend.position = "right",
    legend.text = element_text(size = 9)
  ) +
  scale_y_continuous(labels = scales::comma_format()) +
  scale_x_continuous(limits = c(10, NA))

ggplotly(p_scatter_filtered, tooltip = "text")
```

### Category Summary

```{r, message=FALSE, warning=FALSE}
# Aggregate by document categories
category_summary <- categorized_data %>%
  group_by(document_category) %>%
  summarise(
    total_documents = sum(document_count),
    unique_subtypes = n(),
    max_patients_reached = max(unique_patient_count),
    avg_docs_per_patient = round(mean(docs_per_patient, na.rm = TRUE), 2),
    max_coverage_pct = round(max(patient_coverage_pct, na.rm = TRUE), 2),
    .groups = 'drop'
  ) %>%
  arrange(desc(total_documents))

# Display category summary
category_summary %>%
  DT::datatable(
    caption = "Document Category Summary with Aggregated Metrics",
    options = list(
      pageLength = 20,
      scrollX = TRUE,
      dom = 't'
    ),
    rownames = FALSE,
    colnames = c(
      "Document Category",
      "Total Documents",
      "Sub-Types Count",
      "Max Patients Reached",
      "Avg Docs per Patient",
      "Max Coverage %"
    )
  ) %>%
  DT::formatCurrency(c("total_documents", "unique_subtypes", "max_patients_reached"), currency = "", interval = 3, mark = ",", digits = 0) %>%
  DT::formatRound(c("avg_docs_per_patient", "max_coverage_pct"), digits = 2) %>%
  DT::formatStyle(
    "total_documents",
    background = DT::styleColorBar(category_summary$total_documents, "#e8f4f8"),
    backgroundSize = "90% 80%",
    backgroundRepeat = "no-repeat",
    backgroundPosition = "center"
  )
```

### Category Distribution Visualization

```{r, message=FALSE, warning=FALSE, fig.width=12, fig.height=8}
# Create category distribution chart
p_category <- category_summary %>%
  mutate(
    document_category = factor(document_category, levels = rev(document_category)),
    percentage = round((total_documents / sum(total_documents)) * 100, 1)
  ) %>%
  ggplot(aes(x = total_documents, y = document_category)) +
  geom_col(aes(fill = document_category), alpha = 0.8) +
  geom_text(aes(label = paste0(percentage, "%")), 
            hjust = -0.1, size = 3, color = "#2c3e50") +
  labs(
    title = "Document Distribution by Category",
    subtitle = "Collapsed from 150+ individual document types into meaningful groups",
    x = "Total Documents",
    y = "Document Category"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 11, color = "#7f8c8d"),
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(size = 10),
    legend.position = "none"
  ) +
  scale_x_continuous(labels = scales::comma_format(), 
                     expand = expansion(mult = c(0, 0.1))) +
  scale_fill_viridis_d(option = "plasma")

ggplotly(p_category, tooltip = c("x", "y", "text"))
```

### Summary Statistics

```{r, message=FALSE, warning=FALSE}
# Calculate summary statistics from combined data
total_documents <- sum(combined_data$document_count)
total_doc_types <- nrow(combined_data)
total_unique_patients <- max(combined_data$unique_patient_count)

# Create summary table
summary_stats <- data.frame(
  Metric = c("Total Documents", "Total Document Types", "Total Unique Patients"),
  Count = c(total_documents, total_doc_types, total_unique_patients)
)

summary_stats %>%
  DT::datatable(
    caption = "PDF Media Server Dataset Summary",
    options = list(
      dom = 't',
      pageLength = 10
    ),
    rownames = FALSE
  ) %>%
  DT::formatCurrency("Count", currency = "", interval = 3, mark = ",", digits = 0)
```


