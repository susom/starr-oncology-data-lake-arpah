---
title: "Oncology Cohort"
execute:
  echo: false
output: html
---

```{r setup, include=FALSE}
if (!require("UpSetR")) {
  install.packages("UpSetR")
}
if (!require("viridis")) {
  install.packages("viridis")
}
library(viridis)

if (!require("ggupset")) {
  install.packages("ggupset")
}
library(ggupset)
```




```{r, message=FALSE, warning=FALSE, results='hide'}
rm(list=ls())
source("/workspaces/starr-oncology-data-lake-arpah/src/R/all_function.R", encoding = "UTF-8")
yaml_file_path <-  "/workspaces/starr-oncology-data-lake-arpah/src/sql_params.yml"

```

### **Population Summary**
As of the May 2025 oncology OMOP population:

```{r, message=FALSE, warning=FALSE, results='hide'}
den <- "/workspaces/starr-oncology-data-lake-arpah/src/sql/arpah_cohort/arpah_denominators.sql"
den_res <- fetch_data_from_sql_file(den, yaml_file_path)

den_res=den_res %>% arrange(desc(percentage))
```


*Release Version: May 2025 (IRB76049)*

The oncology OMOP cohort is defined as all patients with an existing record in STARR-OMOP who are either listed in the Stanford Cancer Registry (also known as Neural Frame), or have had a Tumor Board encounter. As of the May 2025 OMOP population, `r format( den_res$counts_pts[den_res$data_set=="Oncology OMOP (Cohort)"][1], big.mark = ",")` patients met the criteria for cancer cohort.

  - **Neural Frame:** Defined as research-eligible patients with case records in Neural Frame (aka Stanford Cancer Registry).

  - **Tumor Board encounter:** These encounters are defined using the EPIC patient encounter data tables.

  - **Philips ISPM:** Includes genomic testing information from the Philips IntelliSpace Precision Medicine (ISPM) genomics database at Stanford.
  These metrics have been generated using the latest Stanford OMOP data including the image occurrence,  Neural Frame data, and Philips ISPM.

  - **OMOP Image Occurrence:** A record of image series from the Vendor Neutral Archive. This does not include Echocardiograms, Ophthalmology images, or Pathology slides at present. We are also only including image occurrences that can be linked to the clarity procedure order information.

```{r, message=FALSE, warning=FALSE, results='hide'}
folder_path_tb <- "/workspaces/starr-oncology-data-lake-arpah/src/sql/tumor_board/tumor_board_person_metrics.sql"
res_tb <- fetch_data_from_sql_file(folder_path_tb, yaml_file_path)
res_tb
```
```{r, message=FALSE, warning=FALSE}
# Modify the data frame to show hierarchy
labels <- c(
  "data_set"="Data Source",
  "counts_pts" = "Number of Patients"
)

den_res_formatted <- den_res %>%
  mutate(
    data_set = case_when(
      data_set == "With Image Occurrence" ~ "  • With Image Occurrence",
      data_set == "With Tumor Board Encounter" ~ "  • With Tumor Board Encounter",
      TRUE ~ data_set
    )
  ) %>%
  # Ensure proper ordering
  slice(match(c(
    "Oncology OMOP (Cohort)",
    "  • With Tumor Board Encounter",
    "  • With Image Occurrence",
    "Neural Frame",
    "Philips ISPM"
  ), data_set))


  # Create the formatted table
  create_gt_table_v1(
    data = den_res_formatted,
    columns = c("data_set", "counts_pts"),
    labels = labels
  ) %>%
  tab_style(
    style = cell_text(indent = px(20)),
    locations = cells_body(
      columns = "data_set",
      rows = str_detect(data_set, "^\\s+•")
    )
  )
```

```{r, message=FALSE, warning=FALSE, results='hide'}
sql_ids <- "/workspaces/starr-oncology-data-lake-arpah/src/sql/arpah_cohort/arpah_overlap_metrics.sql"
res <- fetch_data_from_sql_file(sql_ids, yaml_file_path)
head (res)
```


### Overlap between Data Sources

The following plot represents patients overlap between different data sources:

- The connected dots in the middle show which combinations of data sources exist

- The bars show how many patients are in each combination

For example, if dots are connected for "Oncology OMOP" and "Neural Frame", the bar above shows how many patients are in both sources.

```{r upset plot, message=FALSE, warning=FALSE, results='hide', include='FALSE'}

library(UpSetR)
library(tidyr)

# Convert the data to binary presence/absence matrix
overlap_matrix <- res %>%
  mutate(value = TRUE) %>%
  pivot_wider(
    names_from = data_set,
    values_from = value,
    values_fill = FALSE
  )

# Create the UpSet plot with lighter colors and better labeling
upset(
  fromList(list(
    "Oncology OMOP" = overlap_matrix$person_id[overlap_matrix$`Oncology OMOP`],
    "Image Occurrence" = overlap_matrix$person_id[overlap_matrix$`Image Occurrence`],
    "Neural Frame" = overlap_matrix$person_id[overlap_matrix$`Neural Frame`],
    "Philips ISPM" = overlap_matrix$person_id[overlap_matrix$`Philips ISPM`],
    "Tumor Board" = overlap_matrix$person_id[overlap_matrix$`Tumor Board`]
  )),
  sets = c("Oncology OMOP", "Image Occurrence", "Neural Frame", "Philips ISPM",  "Tumor Board"),
  order.by = "freq",
  mainbar.y.label = "Number of Patients",
  sets.x.label = "",
  #sets.x="", ## remove the xaxis
  point.size = 7,
  line.size = 0.8,
  text.scale = 1.5,
  mb.ratio = c(0.6, 0.4),
  keep.order = TRUE,
  matrix.color = "#8B0000",  
  main.bar.color = "#8B0000",
  sets.bar.color = NA,
  scale.sets = "binary",
  number.angles = 0 ,# Make ,numbers horizontal
  #text.scale = c(1.3, 1.3, 1)  # Increase text size for better readability
)

```



## Patient Distribution Across Data Sources
```{r ggupset, message=FALSE, warning=FALSE}
library(ggplot2)
# Convert data to format needed for ggupset

upset_data <- res %>%
  group_by(person_id) %>%
  summarize(sources = list(data_set)) %>%
  ungroup()

# Create the ggupset plot
ggplot(upset_data, aes(x = sources)) +
  geom_bar(fill = "#8B0000",  width = 0.9) +
  scale_x_upset() +
   geom_text(stat='count', aes(label=after_stat(count)), vjust=-0.4) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank(),
    axis.title.x = element_blank()
  ) +
  labs(
    title = "",
    y = "Number of Patients"
  ) +
  theme(
    plot.title = element_text( size = 14),
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 14)
  )
```

test
```{r}
library(ComplexUpset)
library(ggplot2)
# Prepare the data
overlap_matrix <- res %>%
  mutate(value = TRUE) %>%
  pivot_wider(
    names_from = data_set,
    values_from = value,
    values_fill = FALSE
  )

plot_data <- overlap_matrix %>% 
  select(-person_id) %>%
  mutate(across(everything(), as.logical))

ComplexUpset::upset(
    plot_data,
    intersect = colnames(plot_data),
    width_ratio = 0.1,
    min_size = 10,
    mode = 'inclusive_union',
    intersections = 'all',
    max_degree = 3,
    base_annotations = list(
      'Intersection Size' = (
        intersection_size(
          mode = 'inclusive_union',
          text = list(size = 3),
          aes = list(
            label = expression(
              sprintf(
                "%d\n(%.1f%%)", 
                intersection_size,
                100 * intersection_size/nrow(plot_data)
              )
            )
          )
        )
      )
    ),
    matrix = intersection_matrix(
      geom = geom_point(size = 3.5),
      segment = intersection_segment(color = "#8B0000")
    ),
    set_sizes = (
      upset_set_size(geom = geom_bar(fill = "#8B0000")) +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))
    ),
    themes = upset_modify_themes(
      list(
        'intersections_matrix' = theme(
          text = element_text(size = 12),
          panel.grid = element_blank()
        )
      )
    ),
    sort_sets = "descending",
    sort_intersections = "descending"
)
```

```{r}
# Install and load required package
if (!require("ggvenn")) {
  install.packages("ggvenn")
}
library(ggvenn)
overlap_matrix <- res %>%
  mutate(value = TRUE) %>%
  pivot_wider(
    names_from = data_set,
    values_from = value,
    values_fill = FALSE
  )

# Prepare the data for Venn diagram
venn_data <- list(
  "Oncology OMOP" = overlap_matrix$person_id[overlap_matrix$`Oncology OMOP`],
  "Neural Frame" = overlap_matrix$person_id[overlap_matrix$`Neural Frame`],
  "Philips ISPM" = overlap_matrix$person_id[overlap_matrix$`Philips ISPM`],
  "Image Occurrence" = overlap_matrix$person_id[overlap_matrix$`Image Occurrence`],
  "Tumor Board" = overlap_matrix$person_id[overlap_matrix$`Tumor Board`]
)

# Create enhanced Venn diagram
ggvenn(
  venn_data,
  fill_color = brewer.pal(5, "Set3"),
  stroke_size = 0.5,
  set_name_size = 4,
  show_percentage = TRUE,
  text_size = 3
) +
  theme_void() +
  theme(
    plot.margin = margin(20, 20, 20, 20)
  ) +
  labs(
    title = "Data Source Overlap",
    caption = "Numbers show patient counts and percentages"
  ) +
  theme(
    plot.title = element_text(
      size = 14,
      hjust = 0.5,
      margin = margin(b = 20)
    )
  )
```




