---
title: "Oncology Cohort Characteristics"
execute:
  echo: false
output: html
---

*Release Version: May 2025 (IRB76049)*

The oncology OMOP cohort is defined as all patients with an existing record in STARR-OMOP who are either listed in the Stanford Cancer Registry (also known as Neural Frame), or have had a Tumor Board encounter. As of the May 2025 OMOP population, 201,554 patients met the criteria for cancer cohort.

  - **Neural Frame:** Defined as research-eligible patients with case records in Neural Frame (aka Stanford Cancer Registry)

  - **Tumor Board encounter:** These encounters are defined using the EPIC patient encounter data tables

  - **Philips ISBM:** Includes genomic testing information from the Philips IntelliSpace Precision Medicine (ISPM) genomics database at Stanford.
  These metrics have been generated using the latest Stanford OMOP data including the image occurrence,  Neural Frame data, and Philips ISBM.

  - **OMOP Image Occurrence:** A record of image series from the Vendor Neutral Archive. This does not include Echocardiograms, Ophthalmology images, or Pathology slides at present. We are also only including image occurrences that can be linked to the clarity procedure order information.


```{r, message=FALSE, warning=FALSE, results='hide'}
rm(list=ls())
source("/workspaces/starr-oncology-data-lake-arpah/src/R/all_function.R", encoding = "UTF-8")
yaml_file_path <-  "/workspaces/starr-oncology-data-lake-arpah/src/sql_params.yml"

```

### **Population Summary**
As of the May 2025 oncology OMOP population:

```{r, message=FALSE, warning=FALSE, results='hide'}
den <- "/workspaces/starr-oncology-data-lake-arpah/src/sql/arpah_cohort/arpah_denominators.sql"
den_res <- fetch_data_from_sql_file(den, yaml_file_path)

den_res=den_res %>% arrange(desc(percentage))
```
```{r, message=FALSE, warning=FALSE}
## summary table of dens
labels <- c(
  "data_set"="Data Source",
  "counts_pts" = "Number of Patients",
   "percentage" = "Percent"
)

create_gt_table_v1(
  data = den_res, 
  columns = c( "data_set","counts_pts", "percentage"), 
  labels = labels, 
   subtitle_text = "",
  footnote_text = "")
```
```{r, message=FALSE, warning=FALSE, results='hide'}
sql_ids <- "/workspaces/starr-oncology-data-lake-arpah/src/sql/arpah_cohort/arpah_overlap_metrics.sql"
res <- fetch_data_from_sql_file(sql_ids, yaml_file_path)
head (res)
```

The following graph shows the venn diagram for the above data sources: 





```{r, message=FALSE, warning=FALSE}
# Create Venn diagram
library(eulerr)
library(dplyr)
library(tidyr)
library(RColorBrewer)

venn_sets <- res %>%
  mutate(value = TRUE) %>%
  pivot_wider(
    names_from = data_set,
    values_from = value,
    values_fill = FALSE
  )

# Create a named list for the euler diagram
set_list <- list(
  "Oncology OMOP" = venn_sets$person_id[venn_sets$`Oncology OMOP`],
  "Image Occurrence" = venn_sets$person_id[venn_sets$`Image Occurrence`],
  "Neural Frame" = venn_sets$person_id[venn_sets$`Neural Frame`],
  "Philips ISBM" = venn_sets$person_id[venn_sets$`Philips ISBM`]
)

# Define specific colors for each set
colors <- c( "#377EB8","#4DAF4A", "#FF7F00", "#E41A1C")  # Green, Blue, Orange, Red
names(colors) <- names(set_list)

# Fit and plot the Euler diagram
fit <- euler(set_list, shape = "ellipse")
plot(
  fit,
  fills = list(
    fill = colors,
    alpha = 0.35
  ),
  edges = list(lwd = 1, col = "gray40"),
  quantities = list(
    fontsize = 9,
    type = "counts"
  ),
  labels = list(
    fontsize = 10,
    font = 3
  ),
  main = list(
    label = "Patient Overlap Across Data Sources",
    fontsize = 14,
    font = 2
  ),
  legend = TRUE,
  legend_side = "right",
  repel = TRUE,
  labels_args = list(
    outside = TRUE,
    padding = unit(0.5, "lines"),
    pos = c("bottom", "right", "top", "left")
  )
)
```





