---
title: "Data Lake Growth and Evolution: A Longitudinal Overview"
execute:
  echo: false
---

*Release Version: Nov 2025 (IRB76049)*

## Data Lake Growth and Evolution: A Longitudinal Overview

This report presents a comprehensive analysis of the VISTA Oncology Data Lake's development and expansion across four sequential data releases, spanning from February 2025 through November 2025. By examining key metrics across datasets—including NeuralFrame case data, imaging occurrences, Philips ISPM molecular testing results, and tumor board encounters—this overview captures the trajectory of data integration, completeness, and coverage as the data lake matures.

Understanding how our data resources have grown and evolved over time is essential for:

- **Assessing data completeness**: Tracking which datasets have expanded and how patient coverage has increased
- **Identifying trends**: Observing patterns in data availability and integration across different source systems
- **Documenting progress**: Providing stakeholders with visibility into the data lake's development journey

### Report Structure

For each data release (February, May, August, and November 2025), we examine:

- Patient counts across key datasets (ARPAH cohort, NeuralFrame, Philips ISPM, Imaging data)
- Data availability metrics for primary domains (encounters, diagnoses, procedures, observations)
- Coverage percentages showing the proportion of patients with data in each system
- Notable trends and inflection points in data growth

This longitudinal perspective enables us to track not just *how much* data we have, but *how the composition and reach of our data lake has transformed* over the past nine months.

```{r setup, message=FALSE, warning=FALSE, results='hide'}
# Load required libraries
library(dplyr)
library(yaml)
library(purrr)

# Source the functions
source("/workspaces/starr-oncology-data-lake-arpah/src/R/all_function.R", encoding = "UTF-8")

# Define YAML configuration path
yaml_file_path <- "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql_params.yml"
```

```{r loop through release,  message=FALSE, warning=FALSE, results='hide'}
# Load config from YAML
config <- yaml::read_yaml(yaml_file_path)

# Extract release names (those with nested structure, not top-level scalars)
all_names <- names(config)
releases <- all_names[sapply(config[all_names], is.list)]

# Build datasets_by_month from YAML dynamically
datasets_by_month <- config[releases]

# Map release names to month abbreviations for plotting
release_to_month <- list(
  feb_2025 = "feb",
  may_2025 = "may",
  aug_2025 = "aug",
  nov_2025 = "nov"
)

```

```{r function by time,  message=FALSE, warning=FALSE, results='hide'}
run_monthly_metrics <- function(datasets_by_month,
                                sql_file_path = NULL,
                                sql_file_paths = NULL,
                                release_to_month = NULL,
                                credentials_path = "/home/rstudio/.config/gcloud/application_default_credentials.json") {
  
  # Validate inputs: either sql_file_path OR sql_file_paths must be provided
  if (is.null(sql_file_path) && is.null(sql_file_paths)) {
    stop("❌ Must provide either sql_file_path (single file) or sql_file_paths (named list)")
  }
  
  if (!is.null(sql_file_path) && !is.null(sql_file_paths)) {
    stop("❌ Provide only ONE of: sql_file_path or sql_file_paths, not both")
  }
  
  Sys.setenv(GOOGLE_APPLICATION_CREDENTIALS = credentials_path)
  
  purrr::map_dfr(names(datasets_by_month), function(release_name) {
    
    dataset_map <- datasets_by_month[[release_name]]
    
    # Handle both list and atomic vector structures from YAML
    if (is.list(dataset_map)) {
      project <- dataset_map[["oncology_prod"]]
    } else {
      stop(glue::glue("❌ Unexpected structure for {release_name} in config"))
    }
    
    # Determine which SQL file to use for this release
    if (!is.null(sql_file_paths)) {
      # Release-specific SQL paths provided
      current_sql_path <- sql_file_paths[[release_name]]
      
      if (is.null(current_sql_path)) {
        message(glue::glue("⚠️ No SQL path defined for {release_name}, skipping"))
        return(NULL)
      }
      
      if (!file.exists(current_sql_path)) {
        message(glue::glue("⚠️ SQL file not found for {release_name}: {current_sql_path}"))
        return(NULL)
      }
    } else {
      # Single SQL file for all releases
      current_sql_path <- sql_file_path
    }
    
    # Read and prepare SQL
    sql_query <- readLines(current_sql_path) %>% paste(collapse = "\n")
    
    # Replace ALL placeholders (including oncology_prod project)
    for (placeholder in names(dataset_map)) {
      sql_query <- stringr::str_replace_all(
        sql_query,
        paste0("@", placeholder),
        dataset_map[[placeholder]]
      )
    }
    
    # Connect to BigQuery using project from config
    conn <- DBI::dbConnect(
      bigrquery::bigquery(),
      project = project,
      use_legacy_sql = FALSE
    )
    
    # Run query safely
    result <- tryCatch({
      DBI::dbGetQuery(conn, sql_query)
    }, error = function(e) {
      message(glue::glue("⚠️ Query failed for {release_name}: {e$message}"))
      NULL
    })
    
    DBI::dbDisconnect(conn)
    
    if (!is.null(result)) {
      # Convert release name to month abbreviation for backward compatibility
      month_abbr <- release_to_month[[release_name]] %||% substr(release_name, 1, 3)
      result <- dplyr::mutate(result, month = month_abbr, release = release_name)
    }
    
    result
  })
}

```

```{r}
# Define different SQL paths per release
person_sql_paths <- list(
  feb_2025 = "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql_std/arpah_cohort/feb25/person_metrics.sql",
  may_2025 = "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql_std/arpah_cohort/may_aug25/person_metrics.sql",
  aug_2025 = "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql_std/arpah_cohort/may_aug25/person_metrics.sql",
  nov_2025 = "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql_std/arpah_cohort/nov25/person_metrics.sql"
)

person_res <- run_monthly_metrics(
  datasets_by_month = datasets_by_month,
  sql_file_paths = person_sql_paths  # Note: plural!
)
```


## Release Summary ##
## Table 1
```{r person cnt, message=FALSE, warning=FALSE, results='hide'}
person_res <- run_monthly_metrics(
  datasets_by_month = datasets_by_month,
  sql_file_path = "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql/arpah_cohort/person_metrics.sql"
)
colnames(person_res)<-c("counts", "release")

```

The Oncology-OMOP cohort has grown from `r scales::comma(person_res$counts[person_res$release == "feb"])` patients in February 2025 to `r scales::comma(person_res$counts[person_res$release == "aug"])` patients in August 2025, representing a `r round((as.numeric(gsub(",", "", person_res$counts[person_res$release == "aug"])) - as.numeric(gsub(",", "", person_res$counts[person_res$release == "feb"]))) / as.numeric(gsub(",", "", person_res$counts[person_res$release == "feb"])) * 100, 1)`% increase over this period.


### Demographic Summary ###
The demographic composition of the cohort has remained relatively stable across releases.
```{r demographic , message=FALSE, warning=FALSE }

demog <- run_monthly_metrics(
  datasets_by_month = datasets_by_month,
  sql_file_path = "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql_std/arpah_cohort/may_aug25/demographic_summary.sql"
)
```
```{r demog table, message=FALSE, warning=FALSE}
library(DT)

# Format the demographic data for display
demog_formatted <- demog %>%
  mutate(
    month_label = recode(month,
      "feb" = "February",
      "may" = "May", 
      "aug" = "August",
      "nov" = "November"
    ),
    # Format numbers with commas
    sample_size = scales::comma(sample_size),
    percent_female = paste0(round(percent_female, 1), "%"),
    average_age = round(average_age, 1),
    most_frequent_race_percent = paste0(round(most_frequent_race_percent, 1), "%")
  ) %>%
  select(
    month_label,
    sample_size,
    percent_female,
    average_age,
    most_frequent_race,
    most_frequent_race_percent
  )

# Create interactive table
datatable(
  demog_formatted,
  colnames = c(
    "Release",
    "Sample Size", 
    "% Female",
    "Average Age",
    "Most Frequent Race",
    "Race %"
  ),
  caption = "Demographic Summary Across Data Releases",
  options = list(
    dom = 't',  # Only show table (no search, pagination, etc.)
    pageLength = 10,
    columnDefs = list(
      list(className = 'dt-center', targets = c(1, 2, 3, 5)),  # Center align numeric columns
      list(className = 'dt-left', targets = c(0, 4))  # Left align text columns
    )
  ),
  rownames = FALSE
)
```
### Data Sources Summary Across Releases

```{r overlap metrics, message=FALSE, warning=FALSE, results='hide'}
# Use denominators queries which return aggregated counts
overlap_sql_paths <- list(
  feb_2025 = "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql_std/arpah_cohort/feb25/arpah_denominators.sql",
  may_2025 = "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql_std/arpah_cohort/may_aug25/arpah_denominators.sql",
  aug_2025 = "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql_std/arpah_cohort/may_aug25/arpah_denominators.sql",
  nov_2025 = "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql_std/arpah_cohort/nov25/arpah_denominators_update.sql"
)

overlap_res <- run_monthly_metrics(
  datasets_by_month = datasets_by_month,
  sql_file_paths = overlap_sql_paths,
  release_to_month = release_to_month
)

# Preview the data structure
head(overlap_res)
```

```{r check overlap data, message=FALSE, warning=FALSE}
# Check what data sources are available
unique(overlap_res$data_set)
```

```{r overlap plot, message=FALSE, warning=FALSE}
library(plotly)
library(dplyr)

# Prepare data with proper month ordering and labels
overlap_plot_data <- overlap_res %>%
  mutate(
    month = factor(month, levels = c("feb", "may", "aug", "nov"), ordered = TRUE),
    month_label = recode(month,
      "feb" = "February",
      "may" = "May",
      "aug" = "August",
      "nov" = "November"
    ),
    # Clean up data set names for legend
    data_set_clean = case_when(
      data_set == "Oncology OMOP (Cohort)" ~ "OMOP Cohort (100%)",
      data_set == "Neural Frame" ~ "Neural Frame",
      data_set == "With Tumor Board Encounter" ~ "Tumor Board",
      data_set == "With Image Occurrence" ~ "Image Occurrence",
      data_set == "Philips ISPM" ~ "Philips ISPM",
      TRUE ~ data_set
    )
  ) %>%
  # Remove the 100% baseline to focus on actual data sources
  filter(data_set != "Oncology OMOP (Cohort)") %>%
  # Ensure we have data for all months, fill missing values
  tidyr::complete(month, data_set_clean, fill = list(percentage = 0, counts_pts = 0))

# Create interactive line plot
plot_ly(
  data = overlap_plot_data,
  x = ~month,
  y = ~percentage,
  color = ~data_set_clean,
  type = 'scatter',
  mode = 'lines+markers',
  text = ~paste0(
    data_set_clean, 
    "<br>Month: ", month_label,
    "<br>Coverage: ", round(percentage, 1), "%",
    "<br>Patients: ", scales::comma(counts_pts)
  ),
  hoverinfo = "text",
  marker = list(size = 10),
  line = list(width = 3)
) %>%
  layout(
    title = "Data Source Coverage Across Releases",
    xaxis = list(
      title = "Release Month",
      ticktext = c("February", "May", "August", "November"),
      tickvals = c("feb", "may", "aug", "nov"),
      categoryorder = "array",
      categoryarray = c("feb", "may", "aug", "nov")
    ),
    yaxis = list(
      title = "Patient Coverage (%)",
      range = c(0, 105)
    ),
    legend = list(
      title = list(text = "Data Source"),
      orientation = "v",
      x = 1.02,
      y = 0.5
    ),
    hovermode = 'closest',
    margin = list(r = 150)
  )
```


## Clinical Metrics (Source OMOP) ##

```{r ctsa, message=FALSE, warning=FALSE} 


ctsa_res <- run_monthly_metrics(
  datasets_by_month = datasets_by_month,
  sql_file_path = "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql_std/omop/ctsa/metrics_uniq_pts_vital_overtime.sql",
  release_to_month = release_to_month)

# Named vector of variable label mappings
library(dplyr)

ctsa_res <- ctsa_res %>%
  mutate(group_var = case_when(
    f0_ == "total_patients"              ~ "Total patients in cohort",
    f0_ == "total_pt_gt_12"              ~ "Patients aged ≥ 12 years",
    f0_ == "uniq_pt_any_insurance_value" ~ "Patients with any recorded insurance",
    f0_ == "uniq_pt_cpt"                 ~ "Patients with CPT (procedure) codes",
    f0_ == "uniq_pt_icd_dx"              ~ "Patients with ICD diagnosis codes",
    f0_ == "uniq_pt_icd_proc"            ~ "Patients with ICD procedure codes",
    f0_ == "uniq_pt_loinc"               ~ "Patients with LOINC lab results",
    f0_ == "uniq_pt_med_rxnorm"          ~ "Patients with medications (RxNorm)",
    f0_ == "uniq_pt_note"                ~ "Patients with clinical notes",
    f0_ == "uniq_pt_opioid"              ~ "Patients with opioid prescriptions",
    f0_ == "uniq_pt_smoking"             ~ "Patients with documented smoking status",
    f0_ == "uniq_pt_snomed_dx"           ~ "Patients with SNOMED diagnosis codes",
    f0_ == "uniq_pt_snomed_proc"         ~ "Patients with SNOMED procedure codes",
    f0_ == "uniq_pt_with_age"            ~ "Patients with valid age recorded",
    TRUE ~ f0_  # fallback: keep original if not matched
  ))

```

```{r ctsa plot, message=FALSE, warning=FALSE }

# Check if ctsa_res has data
if (nrow(ctsa_res) == 0) {
  print("No CTSA data available")
} else {
  
  # Prepare data with proper factor levels
  ctsa_res <- ctsa_res %>% 
    mutate(month = factor(month, levels = c("feb", "may", "aug", "nov"))) %>%
    filter(!f0_ %in% c("total_pt_gt_12", "uniq_pt_with_age")) %>%
    filter(!group_var %in% c("Patients with opioid prescriptions", "Patients with any recorded insurance"))

  library(ggplot2)
  library(plotly)
  library(RColorBrewer)
  
  # Define colors for the plot
  bar_colors <- brewer.pal(n = min(11, length(unique(ctsa_res$month))), "Set3")

  # Add formatted release labels
  ctsa_res <- ctsa_res %>%
    mutate(release_label = recode(release,
      "feb_2025" = "February",
      "may_2025" = "May", 
      "aug_2025" = "August",
      "nov_2025" = "November"
    ))

  # Create the plot
  plot_ly(
    data = ctsa_res,
    x = ~f1_,
    y = ~reorder(group_var, f1_),
    color = ~release_label,
    colors = bar_colors,
    type = 'bar',
    orientation = 'h',
    text = ~paste0(group_var, "<br>Release: ", release_label, "<br>Count: ", scales::comma(f1_)),
    hoverinfo = "text"
  ) %>%
    layout(
      title = "Clinical Metrics over Releases",
      xaxis = list(title = "Number of Patients", tickformat = ","),
      yaxis = list(title = "")
    )
}
```




## Notes ##
```{r note, message=FALSE, warning=FALSE , results='hide'}
note_res <- run_monthly_metrics(
  datasets_by_month = datasets_by_month,
  sql_file_path = "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql_std/omop/note_metrics.sql",
  release_to_month = release_to_month)

```


```{r note plot, message=FALSE, warning=FALSE}
library(plotly)
library(dplyr)
library(tidyr)

# Prepare data with proper formatting
note_plot_data <- note_res %>%
  mutate(
    month = factor(month, levels = c("feb", "may", "aug", "nov")),
    month_label = recode(month,
      "feb" = "February",
      "may" = "May",
      "aug" = "August", 
      "nov" = "November"
    ),
    # Calculate reports per patient
    reports_per_patient = round(number_of_note_count / patient_count, 2)
  ) %>%
  # Reshape for dual y-axis plotting
  pivot_longer(
    cols = c(patient_count, number_of_note_count),
    names_to = "metric",
    values_to = "count"
  ) %>%
  mutate(
    metric_label = case_when(
      metric == "patient_count" ~ "Unique Patients",
      metric == "number_of_note_count" ~ "Number of Notes",
      TRUE ~ metric
    )
  )

# Create dual trace plot
plot_ly() %>%
  add_trace(
    data = note_plot_data %>% filter(metric == "number_of_note_count"),
    x = ~month_label,
    y = ~count,
    type = 'scatter',
    mode = 'lines+markers',
    name = 'Number of Notes',
    line = list(color = '#1f77b4', width = 3),
    marker = list(size = 10, color = '#1f77b4'),
    text = ~paste0("Number of Notes<br>", month_label, "<br>Count: ", scales::comma(count)),
    hoverinfo = "text"
  ) %>%
  # Add unique patients trace  
  add_trace(
    data = note_plot_data %>% filter(metric == "patient_count"),
    x = ~month_label,
    y = ~count,
    type = 'scatter',
    mode = 'lines+markers',
    name = 'Unique Patients',
    line = list(color = '#ff7f0e', width = 3),
    marker = list(size = 10, color = '#ff7f0e'),
    text = ~paste0("Unique Patients<br>", month_label, "<br>Count: ", scales::comma(count)),
    hoverinfo = "text",
    yaxis = "y2"
  ) %>%
  layout(
    title = "Growth of Notes and Patient Coverage",
    xaxis = list(title = "Release Month"),
    yaxis = list(
      title = "Number of Notes",
      tickformat = ",",
      side = "left"
    ),
    yaxis2 = list(
      title = "Number of Unique Patients", 
      tickformat = ",",
      overlaying = "y",
      side = "right"
    ),
    legend = list(
      orientation = "h",
      xanchor = "center",
      x = 0.5,
      y = -0.15
    ),
    margin = list(b = 80, r = 80),
    hovermode = 'x unified'
  )

# Summary statistics table
note_summary <- note_res %>%
  mutate(
    month_label = recode(month,
      "feb" = "February",
      "may" = "May", 
      "aug" = "August",
      "nov" = "November"
    ),
    reports_per_patient = round(number_of_note_count / patient_count, 2)
  ) %>%
  select(month_label, patient_count, number_of_note_count, reports_per_patient)


```

## **Thoracic Cancer Sub-Cohort** ##

```{r thoracic metrics, message=FALSE, warning=FALSE, results='hide'}
# Define thoracic-specific SQL paths per release
thoracic_sql_paths <- list(
  feb_2025 = "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql_std/thoracic/feb25/nf_thoracic/scr_thoracic_denominator.sql",
  may_2025 = "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql_std/thoracic/may_aug25/nf_thoracic/scr_thoracic_denominator.sql", 
  aug_2025 = "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql_std/thoracic/may_aug25/nf_thoracic/scr_thoracic_denominator.sql",
  nov_2025 = "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql_std/thoracic/nov25/nf_thoracic/scr_thoracic_denominator.sql"
)

# Run thoracic analysis across releases
thoracic_res <- run_monthly_metrics(
  datasets_by_month = datasets_by_month,
  sql_file_paths = thoracic_sql_paths,
  release_to_month = release_to_month
)

# Preview the results
head(thoracic_res)
```

```{r thoracic plot, message=FALSE, warning=FALSE}
library(plotly)
library(dplyr)


  # Prepare thoracic data for visualization
  thoracic_plot_data <- thoracic_res %>%
    mutate(
      month = factor(month, levels = c("feb", "may", "aug", "nov")),
      month_label = recode(month,
        "feb" = "February", 
        "may" = "May",
        "aug" = "August",
        "nov" = "November"
      )
    )
  
  # Create thoracic trends plot
  plot_ly(
    data = thoracic_plot_data,
    x = ~month_label,
    y = ~unique_thoracic_cancer_pts,  # Adjust column name based on actual query results
    type = 'scatter',
    mode = 'lines+markers',
    name = 'Thoracic Cancer Patients',
    line = list(color = '#e377c2', width = 3),
    marker = list(size = 12, color = '#e377c2'),
    text = ~paste0("Thoracic Patients<br>", month_label, "<br>Count: ", scales::comma(unique_thoracic_cancer_pts)),
    hoverinfo = "text"
  ) %>%
    layout(
      title = "Thoracic Cancer Sub-Cohort Growth Across Releases",
      xaxis = list(title = "Release Month"),
      yaxis = list(
        title = "Number of Thoracic Cancer Patients",
        tickformat = ",",
        range = c(10000, max(thoracic_plot_data$unique_thoracic_cancer_pts) * 1.05)
      ),
      showlegend = FALSE,
      hovermode = 'closest'
    )
  
```

## **Tumor Board** ##

```{r tumor_board_overlap, message=FALSE, warning=FALSE, results='hide'}
# Define tumor board overlap SQL paths per release
tb_overlap_sql_paths <- list(
  ##feb_2025 = "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql_std/tumor_board/feb25/tumor_board_overlap.sql",
  may_2025 = "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql_std/tumor_board/may_aug25/tumor_board_overlap.sql",
  aug_2025 = "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql_std/tumor_board/may_aug25/tumor_board_overlap.sql",
  nov_2025 = "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql_std/tumor_board/nov25/tumor_board_overlap.sql"
)

# Run tumor board overlap analysis across releases
tb_res <- run_monthly_metrics(
  datasets_by_month = datasets_by_month,
  sql_file_paths = tb_overlap_sql_paths,
  release_to_month = release_to_month
)

# Preview the results
head(tb_res)
```

### Tumor Board Patient Counts Across Releases

```{r tb_summary_table, message=FALSE, warning=FALSE}
library(dplyr)
library(knitr)

# Create summary table showing absolute counts
tb_summary <- tb_res %>%
  mutate(
    month_label = recode(month,
    ##  "feb" = "February",
      "may" = "May",
      "aug" = "August",
      "nov" = "November"
    ),
    flag_label = case_when(
      flag == "all_tb" ~ "All Tumor Board",
      flag == "tb_nf" ~ "TB + Neural Frame",
      flag == "tb_imaging_nf" ~ "TB + NF + Imaging",
      flag == "tb_genomic_nf_imaging" ~ "TB + NF + Imaging + Genomics",
      flag == "thoracic_tb" ~ "Thoracic TB Cases",
      TRUE ~ flag
    )
  ) %>%
  select(month_label, flag_label, total_patients) %>%
  tidyr::pivot_wider(
    names_from = month_label,
    values_from = total_patients
  )

knitr::kable(
  tb_summary,
  col.names = c("Category", "May", "August", "November"),
  caption = "Tumor Board Patient Counts by Data Integration Level",
  format.args = list(big.mark = ",")
)
```

### Tumor Board Data Integration Trends

```{r tb_trends_plot, message=FALSE, warning=FALSE}
library(plotly)
library(dplyr)

# Prepare data for visualization
tb_plot_data <- tb_res %>%
  filter(flag != "all_tb") %>%  # Exclude baseline for clearer visualization
  mutate(
    month = factor(month, levels = c("feb", "may", "aug", "nov")),
    month_label = recode(month,
      "feb" = "February",
      "may" = "May",
      "aug" = "August",
      "nov" = "November"
    ),
    flag_label = case_when(
      flag == "tb_nf" ~ "TB + Neural Frame",
      flag == "tb_imaging_nf" ~ "TB + NF + Imaging",
      flag == "tb_genomic_nf_imaging" ~ "TB + NF + Imaging + Genomics",
      flag == "thoracic_tb" ~ "Thoracic TB Cases",
      TRUE ~ flag
    )
  )

# Create line plot showing trends
plot_ly(
  data = tb_plot_data,
  x = ~month_label,
  y = ~total_patients,
  color = ~flag_label,
  type = 'scatter',
  mode = 'lines+markers',
  text = ~paste0(
    flag_label,
    "<br>Release: ", month_label,
    "<br>Patients: ", scales::comma(total_patients)
  ),
  hoverinfo = "text",
  marker = list(size = 10),
  line = list(width = 3)
) %>%
  layout(
    title = "Tumor Board Data Integration Growth Across Releases",
    xaxis = list(
      title = "Release Month",
      categoryorder = "array",
      categoryarray = c("February", "May", "August", "November")
    ),
    yaxis = list(
      title = "Number of Patients",
      tickformat = ","
    ),
    legend = list(
      title = list(text = "Integration Level"),
      orientation = "v",
      x = 1.02,
      y = 0.5
    ),
    hovermode = 'closest',
    margin = list(r = 200)
  )
```

### Data Completeness by Release

```{r tb_completeness, message=FALSE, warning=FALSE}
library(dplyr)
library(plotly)

# Calculate coverage percentages relative to all TB patients
tb_coverage <- tb_res %>%
  group_by(month) %>%
  mutate(
    all_tb_count = total_patients[flag == "all_tb"],
    coverage_pct = (total_patients / all_tb_count) * 100
  ) %>%
  ungroup() %>%
  filter(flag != "all_tb") %>%
  mutate(
    month = factor(month, levels = c("feb", "may", "aug", "nov")),
    month_label = recode(month,
      "feb" = "February",
      "may" = "May",
      "aug" = "August",
      "nov" = "November"
    ),
    flag_label = case_when(
      flag == "tb_nf" ~ "TB + Neural Frame",
      flag == "tb_imaging_nf" ~ "TB + NF + Imaging",
      flag == "tb_genomic_nf_imaging" ~ "TB + NF + Imaging + Genomics",
      flag == "thoracic_tb" ~ "Thoracic TB Cases",
      TRUE ~ flag
    )
  )

# Create grouped bar chart showing coverage
plot_ly(
  data = tb_coverage,
  x = ~month_label,
  y = ~coverage_pct,
  color = ~flag_label,
  type = 'bar',
  text = ~paste0(flag_label, ": ", round(coverage_pct, 1), "%"),
  hoverinfo = "text"
) %>%
  layout(
    title = "Tumor Board Data Coverage by Release",
    xaxis = list(
      title = "Release Month",
      categoryorder = "array",
      categoryarray = c("February", "May", "August", "November")
    ),
    yaxis = list(
      title = "Coverage (%)",
      range = c(0, 105)
    ),
    barmode = 'group',
    legend = list(
      title = list(text = "Integration Level"),
      orientation = "v"
    ),
    hovermode = 'x unified'
  )
```

```{r}

```