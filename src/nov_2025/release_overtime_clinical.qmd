---
title: "Oncology Data Lake"
execute:
  echo: false
---

*Release Version: Nov 2025 (IRB76049)*


```{r, message=FALSE, warning=FALSE, results='hide'}
rm(list=ls())
source("/workspaces/starr-oncology-data-lake-arpah/src/R/all_function.R", encoding = "UTF-8")
yaml_file_path <-  "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql_params.yml"

```

```{r loop through release,  message=FALSE, warning=FALSE, results='hide'}

library(dplyr)
sql_file_path <- "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql/CTSA/metrics_uniq_pts_vital_overtime.sql"
sql_query <- readLines(sql_file_path) %>% paste(collapse = "\n")

# Define the datasets per month
datasets_by_month <- list(
  feb = list(
    oncology_omop = "oncology_omop_phi_irb76049_feb2025",
    oncology_neuralframe = "oncology_neuralframe_phi_irb76049_feb2025"
  ),
  may = list(
    oncology_omop = "oncology_omop_phi_irb76049_may2025",
    oncology_neuralframe = "oncology_neuralframe_phi_irb76049_may2025",
    oncology_philips = "oncology_philips_phi_irb76049_may2025"
  ),
  aug = list(
    oncology_omop = "oncology_omop_phi_irb76049_aug2025",
    oncology_neuralframe = "oncology_neuralframe_phi_irb76049_aug2025",
    oncology_philips = "oncology_philips_phi_irb76049_aug2025"
  )
)


all_results <- purrr::map_dfr(names(datasets_by_month), function(month_name) {
  
  dataset_map <- datasets_by_month[[month_name]]
  
  # Replace placeholders in SQL
  sql_query <- readLines("/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql/CTSA/metrics_uniq_pts_vital_overtime.sql") %>%
    paste(collapse = "\n")
  
  for (placeholder in names(dataset_map)) {
    sql_query <- stringr::str_replace_all(sql_query, paste0("@", placeholder), dataset_map[[placeholder]])
  }
  
  credentials_path <- "/home/rstudio/.config/gcloud/application_default_credentials.json"
project <- "som-rit-phi-oncology-prod"

  Sys.setenv(GOOGLE_APPLICATION_CREDENTIALS = credentials_path)

  # Connect to BigQuery
  conn <- dbConnect(
    bigrquery::bigquery(),
    project = project,
    use_legacy_sql = FALSE
  )

  # Run the query (same as before)
  result <- tryCatch({
    dbGetQuery(conn, sql_query)
  }, error = function(e) {
    message(glue::glue("⚠️ Query failed for month={month_name}: {e$message}"))
    return(NULL)
  })
  
  if (!is.null(result)) {
    result <- result %>% mutate(month = month_name)
  }
  
  return(result)
})




all_results <- list()

for (month_name in names(datasets_by_month)) {
  dataset_map <- datasets_by_month[[month_name]]
  
  sql_query <- readLines(sql_file_path) %>% paste(collapse="\n")
  
  for (placeholder in names(dataset_map)) {
    sql_query <- stringr::str_replace_all(sql_query, paste0("@", placeholder), dataset_map[[placeholder]])
  }
  
  res <- tryCatch({
    dbGetQuery(conn, sql_query)
  }, error=function(e) {
    message(glue::glue("⚠️ Query failed for month={month_name}: {e$message}"))
    return(NULL)
  })
  
  if (!is.null(res)) res$month <- month_name
  all_results[[month_name]] <- res
}

final_df <- dplyr::bind_rows(all_results)


```

```{r function by time,  message=FALSE, warning=FALSE, results='hide'}
run_monthly_metrics <- function(datasets_by_month,
                                sql_file_path,
                                project = "som-rit-phi-oncology-prod",
                                credentials_path = "/home/rstudio/.config/gcloud/application_default_credentials.json") {
  
  Sys.setenv(GOOGLE_APPLICATION_CREDENTIALS = credentials_path)
  
  purrr::map_dfr(names(datasets_by_month), function(month_name) {
    
    dataset_map <- datasets_by_month[[month_name]]
    
    # Read and prepare SQL
    sql_query <- readLines(sql_file_path) %>% paste(collapse = "\n")
    
    for (placeholder in names(dataset_map)) {
      sql_query <- stringr::str_replace_all(
        sql_query,
        paste0("@", placeholder),
        dataset_map[[placeholder]]
      )
    }
    
    # Connect to BigQuery
    conn <- DBI::dbConnect(
      bigrquery::bigquery(),
      project = project,
      use_legacy_sql = FALSE
    )
    
    # Run query safely
    result <- tryCatch({
      DBI::dbGetQuery(conn, sql_query)
    }, error = function(e) {
      message(glue::glue("⚠️ Query failed for month={month_name}: {e$message}"))
      NULL
    })
    
    DBI::dbDisconnect(conn)
    
    if (!is.null(result)) {
      result <- dplyr::mutate(result, month = month_name)
    }
    
    result
  })
}

```
## Release Summary ##
## Table 1
```{r person cnt, message=FALSE, warning=FALSE, results='hide'}
person_res <- run_monthly_metrics(
  datasets_by_month = datasets_by_month,
  sql_file_path = "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql/arpah_cohort/person_metrics.sql"
)
colnames(person_res)<-c("counts", "release")

```
```{r table1,message=FALSE, warning=FALSE }


library(knitr)
# convert abbreviations to full month names
person_res <- person_res %>%
  mutate(
    release = recode(
      release,
      "feb" = "February",
      "may" = "May",
      "aug" = "August"
    ),
    counts = scales::comma(counts)  # adds commas
  ) %>%
 knitr::kable(
    col.names = c("Number of Patients", "Data Release"),
    caption = "Patient counts per data release"
  )
  
person_res
```

### Data Sources Coverage ####
## Plot 1
```{r arpah den, message=FALSE, warning=FALSE , results='hide'}

arpah_den <- run_monthly_metrics(
  datasets_by_month = datasets_by_month,
  sql_file_path = "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql/arpah_cohort/arpah_denominators.sql"
)

philips_den <- run_monthly_metrics(
  datasets_by_month = datasets_by_month,
  sql_file_path = "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql/arpah_cohort/arpah_denominators_philips.sql"
)
philips_den

philips_den <- bind_rows(
  philips_den,
  tibble(
    month = "feb",
    data_set = "Philips ISPM",
    counts_pts = 0,
    percentage = 0
  )
)

```


```{r growth plot2, message=FALSE, warning=FALSE }
arpah_den=rbind( philips_den, arpah_den)

library(ggplot2)
library(plotly)
library(dplyr)



arpah_den <- arpah_den %>%   distinct() %>%
 # Sort by month and data set
  group_by(data_set) %>%
  mutate(month = factor(month, levels = c("feb", "may", "aug"), ordered = TRUE)
  )

arpah_den <- arpah_den %>%
  mutate(
    month = factor(month, levels = c("feb", "may", "aug"), ordered = TRUE),
    month_label = recode(month,
      "feb" = "February",
      "may" = "May",
      "aug" = "August"
    )
  )
plot_ly(
  data = arpah_den,
  x = ~month,
  y = ~percentage,
  color = ~data_set,
  type = 'scatter',
  mode = 'lines+markers',
  text = ~paste0(
    data_set, "<br>Month: ", month_label,
    "<br>Coverage: ", round(percentage, 1), "%"
  ),
  hoverinfo = "text"
) %>%
  layout(
    title = "Temporal Coverage of Oncology Data Assets",
    xaxis = list(title = "Release Month", ticktext = c("February", "May", "August"),
      tickvals = c("feb", "may", "aug"),
      categoryorder = "array",
      categoryarray = c("feb", "may", "aug")),
    yaxis = list(title = "Patient Coverage (%)", range = c(0, 105)),
    legend = list(title = list(text = "Data Source"))
  )


```


## **Image Occurrence** ##
## Plot 2
```{r image occ basics, message=FALSE, warning=FALSE , results='hide'}
img_res<- run_monthly_metrics(
  datasets_by_month = datasets_by_month,
  sql_file_path ="/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql/image_occ/image_occ_person.sql"
)

```

```{r img occ base, message=FALSE, warning=FALSE}

df <- img_res %>% filter (variable_name=="Number of unique persons in image_occurrence table") %>%
  mutate(month = factor(month, levels = c("feb", "may", "aug")))
library(dplyr)
library(plotly)
# interactive grouped bar plot
p <- plot_ly(
  data = df,
  x = ~month,
  y = ~counts,
  color=~variable_name,
  colors="darkred",
    text = ~paste0( "<br>Month: ", month, "<br>Count: ", scales::comma(counts)),
  hoverinfo = "text",
  type = "bar"
) %>%
  layout(
    title = "Patient Counts by Release with Image Occurrence Data",
    xaxis = list(title = "Release"),
    yaxis = list(title = "Patient Counts", tickformat = ","),
    barmode = "stack"
  )

p <- p %>%
  add_trace(data = df,
            x = ~month,
            y = ~counts,
            type = 'scatter',
            mode = 'lines+markers',
            line = list(color = 'grey', width = 2),
            marker = list(size = 8),
            yaxis = "y",
              showlegend = FALSE) %>%
  layout(
    title = "Counts by Month with Trend Line",
    yaxis = list(title = "Patient Counts", tickformat = ","),
    xaxis = list(title = "Release")
  )
  p
```

## Modality Types ##
## Plot 3
```{r image occ mod, message=FALSE, warning=FALSE , results='hide'}
img_mod<- run_monthly_metrics(
  datasets_by_month = datasets_by_month,
  sql_file_path ="/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql/image_occ/image_occ_modality.sql"
)


library(dplyr)

img_mod <- img_mod %>%
  mutate(
    month = factor(month, levels = c("feb", "may", "aug")),
    modality_group = case_when(
      grepl("^CT|CT/|CT-", modality_source_value) | grepl("PET", modality_source_value) ~ "CT/PET",
      grepl("^MR|MRI|MR/", modality_source_value) ~ "MRI",
      grepl("^XR|X-RAY|XA|XC|XD|XR", modality_source_value) ~ "X-Ray",
      grepl("^US|ULTRASOUND|MG|MG/", modality_source_value) ~ "Ultrasound/Mammography",
      grepl("^NM|NM/", modality_source_value) ~ "Nuclear Medicine",
      grepl("^OT|OTHER|DOC|REPORT|REQUEST|FINDINGS|NONE|NULL", modality_source_value) ~ "Other/Docs",
      TRUE ~ "Other"
    )
  )

#img_mod <- img_mod %>% filter (modality_source_value %in% c("CT", "MRI", "XRAY", "PET"))
```
```{r stack plot modality, message=FALSE, warning=FALSE }
img_mod=img_mod %>% filter(modality_group!="Other" )
img_mod=img_mod %>% filter(modality_group!="Other/Docs" )
#|modality_group!="")
img_summary <- img_mod %>%
  group_by(month, modality_group) %>%
  summarise(counts = sum(unique_person_count), .groups = "drop")



library(plotly)
library(RColorBrewer)
library(scales)

bar_colors <- brewer.pal(n = length(unique(img_summary$modality_group)), "Set2")

# total counts per month

img_p <- plot_ly(img_summary,
             x = ~modality_group,
             y = ~counts,
             color = ~month,
             colors = bar_colors,
             type = 'bar',
             text = ~paste0(modality_group, "<br>Count: ", scales::comma(counts)),
             hoverinfo = "text") %>%
  layout(barmode = 'bar') %>%
  layout(
    title = "Image Occurrence by Modality Groups",
    yaxis = list(title = "Patient Counts", tickformat = ","),
    xaxis = list(title = "Top Modalities")
  )

img_p
```

## Temporal Growth of Modalities ##
## Plot 4
```{r growth plot, message=FALSE, warning=FALSE }
library(plotly)
library(dplyr)



plot_ly(img_summary,
        x = ~month,
        y = ~counts,
        color = ~modality_group,
        type = 'scatter',
        mode = 'lines+markers',
        fill = 'tozeroy',  # shaded area under curve
        hoverinfo = 'text',
        text = ~paste0(
          modality_group, "<br>Month: ", month,
          "<br>Count: ", scales::comma(counts)
        )) %>%
  layout(
    title = "Temporal Growth of Modalities",
    xaxis = list(title = "Release"),
    yaxis = list(title = "Number of Patients", tickformat = ","),
    legend = list(title = list(text = "Modality")),
    shapes = list(
      # optional vertical reference lines for version releases
      list(type = "line", x0 = "may", x1 = "may", y0 = 0, y1 = max(img_summary$counts),
           line = list(dash = "dot", color = "black"))
    )
  )

```


## CTSA Metrics ##

## Plot 5 
```{r ctsa, message=FALSE, warning=FALSE} 

ctsa_res <- run_monthly_metrics(
  datasets_by_month = datasets_by_month,
  sql_file_path = "/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql/CTSA/metrics_uniq_pts_vital_overtime.sql"
)

# Named vector of variable label mappings
library(dplyr)

ctsa_res <- ctsa_res %>%
  mutate(group_var = case_when(
    f0_ == "total_patients"              ~ "Total patients in cohort",
    f0_ == "total_pt_gt_12"              ~ "Patients aged ≥ 12 years",
    f0_ == "uniq_pt_any_insurance_value" ~ "Patients with any recorded insurance",
    f0_ == "uniq_pt_cpt"                 ~ "Patients with CPT (procedure) codes",
    f0_ == "uniq_pt_icd_dx"              ~ "Patients with ICD diagnosis codes",
    f0_ == "uniq_pt_icd_proc"            ~ "Patients with ICD procedure codes",
    f0_ == "uniq_pt_loinc"               ~ "Patients with LOINC lab results",
    f0_ == "uniq_pt_med_rxnorm"          ~ "Patients with medications (RxNorm)",
    f0_ == "uniq_pt_note"                ~ "Patients with clinical notes",
    f0_ == "uniq_pt_opioid"              ~ "Patients with opioid prescriptions",
    f0_ == "uniq_pt_smoking"             ~ "Patients with documented smoking status",
    f0_ == "uniq_pt_snomed_dx"           ~ "Patients with SNOMED diagnosis codes",
    f0_ == "uniq_pt_snomed_proc"         ~ "Patients with SNOMED procedure codes",
    f0_ == "uniq_pt_with_age"            ~ "Patients with valid age recorded",
    TRUE ~ f0_  # fallback: keep original if not matched
  ))

```

```{r ctsa plot, message=FALSE, warning=FALSE }

 ctsa_res=ctsa_res %>% mutate(month = factor(month, levels = c("feb", "may", "aug")))

ex=c("total_pt_gt_12", "uniq_pt_with_age")
ctsa_res=ctsa_res %>% filter (!f0_%in% ex)

library(ggplot2)

bar_colors <- brewer.pal(n = length(unique(img_summary$modality_group)), "Set3")

library(plotly)

plot_ly(
  data = ctsa_res,
  x = ~f1_,
  y = ~reorder(group_var, f1_),
  color=~month,
  colors=bar_colors,
  type = 'bar',
  orientation = 'h',
  text = ~paste0(group_var, "<br>Count: ", scales::comma(f1_)),
  hoverinfo = "text"
) %>%
  layout(
    title = "CTSA Metrics over Releases",
    xaxis = list(title = "Number of Patients", tickformat = ","),
    yaxis = list(title = "")
  )
```

## **Pathology Notes** ##

## Plot 6
```{r note, message=FALSE, warning=FALSE , results='hide'}
note_res<- run_monthly_metrics(
  datasets_by_month = datasets_by_month,
  sql_file_path ="/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql/arpah_clinical/note_path_cyto_person_metrics.sql"
)

```


```{r note plot, message=FALSE, warning=FALSE}
# Reshape data for plotting
library(tidyr)
note_long <- note_res %>%
  pivot_longer(
    cols = c(patient_count, pathology_report_count),
    names_to = "metric",
    values_to = "count"
  ) %>%
  mutate(
    month = factor(month, levels = c("feb", "may", "aug")),
    metric_label = case_when(
      metric == "patient_count" ~ "Unique Patients",
      metric == "pathology_report_count" ~ "Pathology Reports",
      TRUE ~ metric
    )
  )

# Create a plot with shaded areas and bottom legend
plot_ly() %>%
  add_trace(
    data = note_long %>% filter(metric == "pathology_report_count"),
    x = ~month,
    y = ~count,
    type = 'scatter',
    mode = 'lines+markers',
    name = 'Pathology Reports',
    fill = 'tozeroy',
    fillcolor = 'rgba(31, 119, 180, 0.3)',
    line = list(color = '#1f77b4', width = 3),
    marker = list(size = 10)
  ) %>%
  add_trace(
    data = note_long %>% filter(metric == "patient_count"),
    x = ~month,
    y = ~count,
    type = 'scatter',
    mode = 'lines+markers',
    name = 'Unique Patients',
    fill = 'tozeroy',
    fillcolor = 'rgba(255, 127, 14, 0.3)',
    line = list(color = '#ff7f0e', width = 3),
    marker = list(size = 10)
  ) %>%
  layout(
    title = "Growth of Pathology Notes and Patient Coverage",
    xaxis = list(
      title = "Release Month",
      ticktext = c("February", "May", "August"),
      tickvals = c("feb", "may", "aug")
    ),
    yaxis = list(
      title = "Count",
      tickformat = ",",
      rangemode = "tozero"  # Ensures the shading goes down to zero
    ),
    showlegend = TRUE,
    legend = list(
      orientation = "h",     # horizontal legend
      xanchor = "center",    # center the legend
      x = 0.5,              # position at the middle
      y = -0.2              # position below the plot
    ),
    margin = list(b = 100), # add more bottom margin to accommodate the legend
    hovermode = 'x unified'
  )

# Calculate and display some statistics
note_stats <- note_res %>%
  group_by(month) %>%
  mutate(
    reports_per_patient = round(pathology_report_count / patient_count, 2),
    month = recode(month,
      "feb" = "February",
      "may" = "May",
      "aug" = "August"
    )
  ) %>%
  select(month, reports_per_patient)

# Create a statistics table
knitr::kable(
  note_stats,
  col.names = c("Month", "Reports per Patient"),
  caption = "Average Number of Pathology Reports per Patient"
)
```


## **Tumor Board** ##
 
## Plot 7

```{r, message=FALSE, warning=FALSE , results='hide'}
tb_res<- run_monthly_metrics(
  datasets_by_month = datasets_by_month,
  sql_file_path ="/workspaces/starr-oncology-data-lake-arpah/src/nov_2025/sql/tumor_board/tumor_board_overlap.sql"
)

```

```{r, results='hide'}
tb_p <- tb_res %>%
  group_by(month) %>%
  mutate(all_tb_val = total_patients[flag == "all_tb"]) %>%
  ungroup() %>%
  mutate(ratio = total_patients / all_tb_val) %>%
  filter(flag != "all_tb") %>%
  mutate(month = forcats::fct_relevel(month, "may", "aug"))


# Compute proportions per month relative to all_tb
df_rel <- tb_res %>%
  group_by(month) %>%
  mutate(all_tb_val = total_patients[flag == "all_tb"]) %>%
  ungroup() %>%
  mutate(prop = total_patients / all_tb_val) %>%
  filter(flag != "all_tb")

# Function to make one donut per month
make_donut <- function(data, month_label) {
  ggplot(data, aes(x = 2, y = prop, fill = flag)) +
    geom_col(width = 1, color = "white") +
    coord_polar(theta = "y") +
    xlim(0.5, 2.5) +
    labs(title = paste("Month:", month_label)) +
    theme_void(base_size = 14) +
    theme(
      legend.position = "none",
      plot.title = element_text(hjust = 0.5, face = "bold")
    ) +
    geom_text(
      aes(label = paste0(round(prop * 100, 1), "%")),
      position = position_stack(vjust = 0.5),
      color = "white",
      size = 4
    )
}

# Make donuts for each month
plots <- df_rel %>%
  split(.$month) %>%
  lapply(function(x) make_donut(x, unique(x$month)))

# Combine donuts side-by-side with shared legend
final_plot <- patchwork::wrap_plots(plots, nrow = 1) +
  patchwork::plot_annotation(
    title = "Distribution of TB Subgroups Relative to All TB per Month",
    theme = theme(plot.title = element_text(size = 16, face = "bold", hjust = 0.5))
  )






# Prepare data: compute proportions relative to all_tb per month
df2 <- tb_res %>%
  group_by(month) %>%
  mutate(all_tb_val = total_patients[flag == "all_tb"]) %>%
  ungroup() %>%
  mutate(prop = total_patients / all_tb_val) %>%
  # separate inner (all_tb) vs outer (others) rings
  mutate(ring = if_else(flag == "all_tb", "Total all_tb", "Sub-flags"))

# For nested rings we need to build something like two geom_rect/geom_bar layers
df_plot <- df2 %>%
  arrange(month, ring, flag) %>%
  group_by(month, ring) %>%
  mutate(ymax = cumsum(prop),
         ymin = lag(ymax, default = 0)) %>%
  ungroup() %>%
  mutate(radius_inner = if_else(ring == "Total all_tb", 1, 1.5),
         radius_outer = if_else(ring == "Total all_tb", 1.2, 1.8))

# Example for one month (say “may”)
p_may <- df_plot %>% filter(month == "may") %>%
  ggplot() +
    geom_rect(aes(ymin = ymin, ymax = ymax,
                  xmin = radius_inner, xmax = radius_outer,
                  fill = flag),
              colour = "white") +
    coord_polar(theta = "y") +
    xlim(0, 2) +
    theme_void() +
    labs(title = "May: TB sub-flags relative to all_tb") +
    theme(legend.position = "right",
          plot.title = element_text(face = "bold"))


```



```{r donut_plot, message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(patchwork)  # to combine plots

df_plot <- df2 %>%
  arrange(month, ring, flag) %>%
  group_by(month, ring) %>%
  mutate(
    ymax = cumsum(prop),
    ymin = lag(ymax, default = 0),
    # Calculate middle position for labels
    label_position = (ymin + ymax) / 2,
    # Format percentage labels
    percentage_label = sprintf("%.1f%%", prop * 100),
    # Create better flag labels
    flag_label = case_when(
      flag == "tb_nf" ~ "Neural Frame",
      flag == "tb_imaging_nf" ~ "NF + Imaging",
      flag == "tb_genomic_nf_imaging" ~ "NF + Imaging + Genomics",
      flag == "thoracic_tb" ~ "Thoracic Cases",
      TRUE ~ flag
    )
  ) %>%
  ungroup() %>%
  mutate(
    radius_inner = if_else(ring == "Total all_tb", 1, 1.5),
    radius_outer = if_else(ring == "Total all_tb", 1.2, 1.8)
  )

# Create enhanced donut plot for May
p_may <- df_plot %>% 
  filter(month == "may") %>%
  ggplot() +
    # Add the donut segments
    geom_rect(aes(
      ymin = ymin, 
      ymax = ymax,
      xmin = radius_inner, 
      xmax = radius_outer,
      fill = flag_label
    ), colour = "white") +
    # Add percentage labels
    geom_text(aes(
      x = (radius_inner + radius_outer) / 2,
      y = label_position,
      label = percentage_label
    ), size = 3.5) +
    # Customize the plot
    coord_polar(theta = "y") +
    xlim(0, 2) +
    scale_fill_brewer(palette = "Set3", name = "Categories") +
    labs(
      title = "May 2025: Tumor Board Categories",
      subtitle = "",
      fill = "Category"
    ) +
    theme_void() +
    theme(
      legend.position = "right",
      plot.title = element_text(face = "bold", hjust = 0.5, size = 14),
      plot.subtitle = element_text(hjust = 0.5, size = 10),
      legend.title = element_text(face = "bold"),
      legend.text = element_text(size = 9),
      plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
    )

# Display the plot
p_may

# Create a function to generate plots for any month
create_donut_plot <- function(data, month_name) {
  data %>% 
    filter(month == month_name) %>%
    ggplot() +
      geom_rect(aes(
        ymin = ymin, 
        ymax = ymax,
        xmin = radius_inner, 
        xmax = radius_outer,
        fill = flag_label
      ), colour = "white") +
      geom_text(aes(
        x = (radius_inner + radius_outer) / 2,
        y = label_position,
        label = percentage_label
      ), size = 3.5) +
      coord_polar(theta = "y") +
      xlim(0, 2) +
      scale_fill_brewer(palette = "Set3", name = "Categories") +
      labs(
        title = paste(tools::toTitleCase(month_name), "2025: Tumor Board Categories"),
        subtitle = "",
        fill = "Category"
      ) +
      theme_void() +
      theme(
        legend.position = "right",
        plot.title = element_text(face = "bold", hjust = 0.5, size = 14),
        plot.subtitle = element_text(hjust = 0.5, size = 10),
        legend.title = element_text(face = "bold"),
        legend.text = element_text(size = 9),
        plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
      )
}

# Create plots for all months
library(patchwork)
p_feb <- create_donut_plot(df_plot, "feb")
p_may <- create_donut_plot(df_plot, "may")
p_aug <- create_donut_plot(df_plot, "aug")

# Combine all plots
combined_plots <- p_may + p_aug +
  plot_layout(guides = "collect") & 
  theme(legend.position = "bottom")

# Display combined plots
combined_plots
```